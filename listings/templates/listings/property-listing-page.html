{% extends 'base1.html' %}
{% load static %}
{% load cloudinary %}
{% block title %}<title>Real Estate for {% if listing.listing_type == 'for_sale' %} sale {% else %} rent {% endif %} in {{location_address}} | Rehgien</title>{% endblock %}
{% block content%}

<section id="_listingPageElements_">
  <div id="upfPageAcScs" class="_upfPageAcScs">
  </div>
  <div id="upfPageAcErr" class="_upfPageAcErr">
  </div>
  <data id="_sQstring_ospamxcpl" hidden value="{{query_string}}"></data>
  <div class="ListingsMapWrapper">
    <div id="filter-cont" class="propertyLs_flter_container">
      <fieldset id="fieldset">
            <form id="_lsRsFl_Form" autocomplete='off' class="ResultsFilterBar"
              action="{% url 'listings:property-listings' property_category=property_category property_listing_type=property_listing_type %}" method="get"
              >
              <div class="_ResultsFilterBarFWr">
                  <div class="_ResultsFilterFld geocoderInWrap_dflt" style='width:auto; padding:0;'>
                    <div id='geocoder' class='geocoder'></div>
                  </div>
                  <div id="collapsFilters" class="collapsibleExtraFilters">
                    <div class="_ResultsFilterFld">
                      <ul class="collapsible">
                        <li>
                          <button class="collapsible-header" type="button" name="button">Price</button>
                          <div class="collapsible-body left_di_open">
                            <div style='width:auto; padding:0;'>
                              <h6 class="fltr-h-helper">Select a price range</h6>
                              {% if property_listing_type == 'for_sale' %}
                                <div id="price-slider">
                                  <div id="price-from" class="input-field">
                                   <select id="" name='min_price'>
                                     <option value="" disabled>Price From</option>
                                     <option value="0" selected>No min</option>
                                     <option value="1000000">1M+</option>
                                     <option value="2000000">2M+</option>
                                     <option value="3000000">3M+</option>
                                     <option value="4000000">4M+</option>
                                     <option value="6000000">6M+</option>
                                     <option value="10000000">10M+</option>
                                     <option value="15000000">15M+</option>
                                     <option value="30000000">30M+</option>
                                     <option value="60000000">60M+</option>
                                     <option value="100000000">100M+</option>
                                   </select>
                                 </div>
                                 <div class="dash-separator">
                                   -
                                 </div>
                                 <div id="price-to" class="input-field col s12">
                                  <select id="dsfsdfs" name='max_price'>
                                    <option value="" disabled>Price To</option>
                                    <option value="1000000">1M</option>
                                    <option value="2000000">2M</option>
                                    <option value="3000000">3M</option>
                                    <option value="4000000">4M</option>
                                    <option value="6000000">6M</option>
                                    <option value="10000000">10M</option>
                                    <option value="15000000">15M</option>
                                    <option value="30000000">30M</option>
                                    <option value="60000000">60M</option>
                                    <option value="100000000">100M</option>
                                    <option value="All" selected>No max</option>
                                  </select>
                                </div>
                                </div>
                              {% else %}
                                <div id="price-slider">
                                  <div id="price-from" class="input-field col s12">
                                   <select name='min_price'>
                                     <option value="" disabled>Price From</option>
                                     <option value="0"selected>No min</option>
                                     <option value="50000">5K+</option>
                                     <option value="10000">10K+</option>
                                     <option value="20000">10K+</option>
                                     <option value="50000">50K+</option>
                                     <option value="100000">100K+</option>
                                     <option value="150000">150K+</option>
                                     <option value="300000">30K+</option>
                                     <option value="600000">600K+</option>
                                     <option value="1000000">1M+</option>
                                    <option value="10000000">10M+</option>
                                   </select>
                                 </div>
                                 <div class="dash-separator">
                                   -
                                 </div>
                                 <div id="price-to" class="input-field col s12">
                                  <select name='max_price'>
                                    <option value="" disabled>Price To</option>
                                    <option value="50000">5K</option>
                                    <option value="10000">10K</option>
                                    <option value="20000">10K</option>
                                    <option value="50000">50K</option>
                                    <option value="100000">100K</option>
                                    <option value="150000">150K</option>
                                    <option value="300000">300K</option>
                                    <option value="600000">600K</option>
                                    <option value="1000000">1M</option>
                                    <option value="10000000">10M</option>
                                    <option value="All" selected>No max</option>
                                  </select>
                                </div>
                                </div>
                              {% endif %}

                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <div class="_ResultsFilterFld" style='width:auto; padding:0;'>
                      <div id="type-filter" class="input-field">
                         <select name="property_type">
                           <option value="All" selected>All Home Types</option>
                           {% for home_type in home_types%}
                           <option value="{{home_type.name}}">{{home_type.name}}</option>
                           {% endfor %}
                         </select>
                       </div>
                    </div>
                    <div class="_ResultsFilterFld" style='width:auto; padding:0;'>
                      <ul class='collapsible'>
                          <li>
                              <button class='collapsible-header' name="button" type='button'> More</button>
                              <div class="collapsible-body right_di_open">
                                   <div style='width:auto; padding:0;'>
                                     <h6 class="fltr-h-helper">Beds and baths</h6>
                                     <div class="bdba-input">
                                       <div id="beds" class="input-field">
                                         <span>bedrooms</span>
                                        <select name='bedrooms'>
                                          <option value="0" selected>All beds</option>
                                          <option value="1">1+</option>
                                          <option value="2">2+</option>
                                          <option value="3">3+</option>
                                        </select>
                                      </div>
                                      <div id="baths" class="input-field">
                                        <span>Bathrooms</span>
                                       <select name='bathrooms'>
                                         <option value="0" selected>All baths</option>
                                         <option value="1">1+</option>
                                         <option value="2">2+</option>
                                         <option value="3">3+</option>
                                       </select>
                                     </div>
                                     </div>
                                   </div>
                              </div>
                          </li>
                      </ul>
                    </div>
                    <div class="_ResultsFilterSbt" style="width:auto; padding:0;">
                      <button id="saveSearch_button_dk" class="saveSearch_button" type="button" name="saveSearch"> Save Search</button>
                    </div>
                  </div>
              </div>
              <input id="submit_f_button" type="submit" name="" hidden>
            </form>
      </fieldset>
    </div>
    <div class="pLSPg_fResults_container">
      <div id="asCont">

        <div id="all-content" class='all-content'>
            {% if listings %}
              <div id="_listingItemsLoading">
                {% include 'listings/listingPlaceholder.html' %}
              </div>
                <div id="all-row2">
                    <div id="page-head" class="page-head">
                      <h2>Real Estate for {% if listing.listing_type == 'for_sale' %} sale {% else %} rent {% endif %} in {{location_address}}.</h2>
                        <h3>{{listings_count}} results.</h3>
                    </div>
                    <div class="_listingsVwSummary">
                      <div class="_listingsVS_ct">
                        <div class="ls_inStsHpr">
                            <span class="material-icons">help</span>
                            <div class="ls_inStsHpr-Txt">
                              These insights are based on public listings in our database which
                              offer a significant reflection of the areas activity.
                            </div>
                        </div>
                        <h5><span class="material-icons">insights</span> &nbsp Area insights.</h5>
                        <p id="_listingsVS_ctTxt"></p>
                        <div class="_listingsVS_Bxs">
                            <div class="_ls_Bx1">
                              1 &nbsp bed
                              <div id="_ls_Bx1Stats" class="_ls_BxStats">
                                <p id="_ls_Bx1StatsPg"></p>
                                {% if insight_stats.Onebd_median_price > 0 %}
                                  <span class='material-icons'>trending_up</span>
                                {% elif insight_stats.Onebd_median_price == 0%}
                                  <span class='material-icons'>trending_flat</span>
                                {% else %}
                                  <span class='material-icons'>trending_down</span>
                                {% endif %}
                              </div>
                            </div>
                            <div class="_ls_BxS-dr"></div>
                            <div class="_ls_Bx2">
                              2 &nbsp beds
                              <div id="_ls_Bx2Stats" class="_ls_BxStats">
                                <p id="_ls_Bx2StatsPg"></p>
                                {% if insight_stats.Twobd_median_price > 0 %}
                                  <span class='material-icons'>trending_up</span>
                                {% elif insight_stats.Twobd_median_price == 0%}
                                  <span class='material-icons'>trending_flat</span>
                                {% else %}
                                  <span class='material-icons'>trending_down</span>
                                {% endif %}
                              </div>
                            </div>
                              <div class="_ls_BxS-dr"></div>
                            <div class="_ls_Bx3">
                              3+ &nbsp beds
                              <div id="_ls_Bx3pStats" class="_ls_BxStats">
                                <p id="_ls_Bx3StatsPg"></p>
                                {% if insight_stats.threebd_plus_price_trend > 0 %}
                                  <span class='material-icons'>trending_up</span>
                                {% elif insight_stats.threebd_plus_price_trend == 0%}
                                  <span class='material-icons'>trending_flat</span>
                                {% else %}
                                  <span class='material-icons'>trending_down</span>
                                {% endif %}
                              </div>
                            </div>
                              <div class="_ls_BxS-dr"></div>
                            <div class="_ls_Bx4">
                              All
                              <div id="_ls_BxAllStats" class="_ls_BxStats">
                                <p id="_ls_BxAllStatsPg"></p>
                                {% if insight_stats.all_prices_trend > 0 %}
                                  <span class='material-icons'>trending_up</span>
                                {% elif insight_stats.all_prices_trend == 0%}
                                  <span class='material-icons'>trending_flat</span>
                                {% else %}
                                  <span class='material-icons'>trending_down</span>
                                {% endif %}
                              </div>
                            </div>
                        </div>
                      </div>
                    </div>
                    <div id="sort-input" class="input-field">
                      <div class="sortItemWrpr">
                      <span>Sort by:</span>
                       <select>
                         <option value="jfy" selected>Just for you</option>
                         <option value="newer">Newer</option>
                         <option value="older">Older</option>
                         <option value="pricelh">Price (Low to high)</option>
                         <option value="pricehl">Price (High to Low)</option>
                         <option value="beds">Beds</option>
                         <option value="baths">Baths</option>
                         <option value="sqft">Square feet</option>
                       </select>
                       </div>
                    </div>
                    <div id="_listingItemsBox" class="_listingItemsBox row">
                        <div id="obj" class="col s12 md6 l6 xl4">

                        </div>
                    </div>
                </div>
                <div id="_ls_paginationWrpr">
                {% include 'listings/pagination.html' with listings=listings %}
                </div>
            {% else %}
                <div id="page-head" class="page-head _empty_listings">
                  <h2>No matching results for {{location_address}}.</h2>
                    <h3>Try another location or refine your search.</h3>
                </div>
            {% endif %}
            <p id="help-text0" class="center" style='display:none;'>
              <span>No matching results</span> Try Refining your search by changing the filters or zooming the map.
            </p>
        </div>
        <footer class="listings-footer">
          <div class="container" style="width:100%; margin:0px;">
            <div class="footer-content center">
              <div class="row">
                <div class="f-details center">
                  <a href="#"> Privacy Policy</a>
                  <a href="#"> Terms & Conditions</a>
                  <a href="#"> Advertise</a>
                  <a href="#"> Mobile App</a>
                  <a href="#"> FAQ'S</a>
                  <a href="#"> Contact Us</a>
                  <a href="{% url 'contact:about_us'%}"> About Us</a>
                </div>
                <div id="footer-details" class="col s12 center">
                  <a href="#" class="black-text">
                    <i class="fab fa-facebook fa-2x"></i>
                  </a>
                  <a href="#" class="black-text">
                    <i class="fab fa-twitter fa-2x"></i>
                  </a>
                  <a href="#" class="black-text">
                    <i class="fab fa-linkedin fa-2x"></i>
                  </a>
                  <a href="#" class="black-text">
                    <i class="fab fa-instagram fa-2x"></i>
                  </a>
                  <p>While using this site, you agree to have read and accepted our terms of use, cookie and privacy policy.</p>
                </div>
                <p class="flow-text black-text center" id="c-year"></p>
                <script type="text/javascript">
                  var d = new Date();
                  document.getElementById("c-year").innerHTML= 'Copyright '+ d.getFullYear();
                </script>
              </div>
            </div>
          </div>
          <div class="ft-bk-sl">
            <img src="{% static 'img/nairobi-skyline.png'%}">
          </div>
        </footer>
        <button id='revealMap' class='show-map-btn'>
          <span class="material-icons">map</span> Map
        </button>
      </div>
      <div id="map-container">
            <div id='map'>
            </div>
            {% if listings %}
              <button type="button" id="hideMapbtn"  class="">
                <span class="material-icons">list</span> List
              </button>
              <!-- Dropdown Trigger -->
              <a id='map-btn' class='dropdown-trigger btn-small blue' href='#' data-target='map-dropdown'><i class="small material-icons">school</i></a>

              <ul id='map-dropdown' class='dropdown-content'>
                <li id="menu-items"></li>
              </ul>
              <div id="mapResultshelp-text1" class="help-text1 center" >
                <img src="{%static 'img/ajax-loader.gif'%}" alt="loading..">
              </div>
              <div id="_MapsMenu">
                    <ul class="collapsible">
                      <li>
                          <button class="collapsible-header" type="button" name="button">Map</button>
                          <div class="collapsible-body">
                              <label for="ckh7o1zaj16uf19livwuytxlq">
                                  <input id="ckh7o1zaj16uf19livwuytxlq" type="radio" name="rtoggle" value="streets" checked="checked"/>
                                  <span>streets</span>
                              </label>
                              <label for="ckh9k2ug82cxr19mv54mrosin">
                                  <input id="ckh9k2ug82cxr19mv54mrosin" type="radio" name="rtoggle" value="satellite" />
                                  <span>satellite</span>
                              </label>
                          </div>
                      </li>
                    </ul>
              </div>
            {%endif%}
      </div>
    </div>
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <div id="_lsPage_AllFeatureLoadScriptsWrpr">
      <div id="_lsPage_AllFeatureLoadScripts">
          <script>
              mapboxgl.accessToken = 'pk.eyJ1IjoicmV5a2VubmVkeSIsImEiOiJjam9td3ZkMnYwdjB5M3ZueWQ1YzVocThwIn0.PBVWnwga3qG6KX6_CoPy8g';
              if (!mapboxgl.supported()) {
                alert('Your browser does not support Mapbox GL. To access map features chooses a different browser!');
                } else {
                  var map = new mapboxgl.Map({
                      container: 'map',
                      style: 'mapbox://styles/reykennedy/ckh7o1zaj16uf19livwuytxlq',
                      minZoom: 6.2,
                      maxZoom:18,
                      center: [37.01, -1.10]
                });
              }

              //geocoder
              var geocoder = new MapboxGeocoder({
              accessToken: mapboxgl.accessToken,
              types: 'country,region,place,postcode,locality,neighborhood',
              countries:'KE',
              placeholder:'Enter an address, city, neighborhood or postcode.'
              });
              geocoder.addTo('#geocoder');
              // disable map rotation using right click + drag
              map.dragRotate.disable();

              // disable map rotation using touch rotation gesture
              map.touchZoomRotate.disableRotation();
              // Adds zoom and rotation controls to the map.
              map.addControl(new mapboxgl.NavigationControl());

              {% if listings %}
                  //adding primary schools data points
                  map.on('style.load', function() {
                      map.loadImage("{% static 'icons/ic_school_black_48dp.png'%}", function(error, image) {
                      if (error) throw error;
                      map.addImage('primary_sch', image);
                        map.addSource('primary_schools',{
                          "type": "geojson",
                          "data": "{%url 'location:primary_schools_data'%}"
                          });
                          map.addLayer({
                          "id": "Primary Schools",
                          "type": "symbol",
                          "source":"primary_schools",
                          "layout": {
                          "visibility":"none",
                          "icon-image": "primary_sch",
                          "icon-size": 0.25
                          }
                        });
                      });

                      // When a click event occurs on a feature in the places layer, open a popup at the
                    // location of the feature, with description HTML from its properties.
                    map.on('click', 'Primary Schools', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var name = e.features[0].properties.name_of_sc;

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(name)
                    .addTo(map);
                    });

                    // Change the cursor to a pointer when the mouse is over the places layer.
                    map.on('mouseenter', 'Primary Schools', function () {
                    map.getCanvas().style.cursor = 'pointer';
                    });

                    // Change it back to a pointer when it leaves.
                    map.on('mouseleave', 'Primary Schools', function () {
                    map.getCanvas().style.cursor = '';
                    });
                  });

                  //adding polytechnics schools data points
                  map.on('style.load', function() {
                      map.loadImage("{% static 'icons/ic_school_black_48dp.png'%}", function(error, image) {
                      if (error) throw error;
                      map.addImage('polytechnics', image);
                        map.addSource('polytechnics_schools',{
                          "type": "geojson",
                          "data": "{%url 'location:polytechnics_data'%}"
                          });
                          map.addLayer({
                          "id": "Technicals",
                          "type": "symbol",
                          "source":"polytechnics_schools",
                          "layout": {
                          "visibility":"none",
                          "icon-image": "polytechnics",
                          "icon-size": 0.25
                          }
                        });
                      });

                      // When a click event occurs on a feature in the places layer, open a popup at the
                    // location of the feature, with description HTML from its properties.
                    map.on('click', 'Technicals', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var name = e.features[0].properties.name;

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(name)
                    .addTo(map);
                    });

                    // Change the cursor to a pointer when the mouse is over the places layer.
                    map.on('mouseenter', 'Technicals', function () {
                    map.getCanvas().style.cursor = 'pointer';
                    });

                    // Change it back to a pointer when it leaves.
                    map.on('mouseleave', 'Technicals', function () {
                    map.getCanvas().style.cursor = '';
                    });
                  });

                  //adding private colleges data points
                  map.on('style.load', function() {
                      map.loadImage("{% static 'icons/ic_school_black_48dp.png'%}", function(error, image) {
                      if (error) throw error;
                      map.addImage('private_coll', image);
                        map.addSource('private_colleges',{
                          "type": "geojson",
                          "data": "{%url 'location:private_colleges_data'%}"
                          });
                          map.addLayer({
                          "id": "Private Colleges",
                          "type": "symbol",
                          "source":"private_colleges",
                          "layout": {
                          "visibility":"none",
                          "icon-image": "private_coll",
                          "icon-size": 0.25
                          }
                        });
                      });

                      // When a click event occurs on a feature in the places layer, open a popup at the
                    // location of the feature, with description HTML from its properties.
                    map.on('click', 'Private Colleges', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var name = e.features[0].properties.name;

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(name)
                    .addTo(map);
                    });

                    // Change the cursor to a pointer when the mouse is over the places layer.
                    map.on('mouseenter', 'Private Colleges', function () {
                    map.getCanvas().style.cursor = 'pointer';
                    });

                    // Change it back to a pointer when it leaves.
                    map.on('mouseleave', 'Private Colleges', function () {
                    map.getCanvas().style.cursor = '';
                    });
                  });

                  //adding private universities data points
                  map.on('style.load', function() {
                      map.loadImage("{% static 'icons/ic_school_black_48dp.png'%}", function(error, image) {
                      if (error) throw error;
                      map.addImage('private_uni', image);
                        map.addSource('private_universities',{
                          "type": "geojson",
                          "data": "{%url 'location:private_universities_data'%}"
                          });
                          map.addLayer({
                          "id": "Private Universities",
                          "type": "symbol",
                          "source":"private_universities",
                          "layout": {
                          "visibility":"none",
                          "icon-image": "private_uni",
                          "icon-size": 0.25
                          }
                        });
                      });

                      // When a click event occurs on a feature in the places layer, open a popup at the
                    // location of the feature, with description HTML from its properties.
                    map.on('click', 'Private Universities', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var name = e.features[0].properties.name;

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(name)
                    .addTo(map);
                    });

                    // Change the cursor to a pointer when the mouse is over the places layer.
                    map.on('mouseenter', 'Private Universities', function () {
                    map.getCanvas().style.cursor = 'pointer';
                    });

                    // Change it back to a pointer when it leaves.
                    map.on('mouseleave', 'Private Universities', function () {
                    map.getCanvas().style.cursor = '';
                    });
                  });

                  //adding public colleges data points
                  map.on('style.load', function() {
                      map.loadImage("{% static 'icons/ic_school_black_48dp.png'%}", function(error, image) {
                      if (error) throw error;
                      map.addImage('public_coll', image);
                        map.addSource('public_colleges',{
                          "type": "geojson",
                          "data": "{%url 'location:public_colleges_data'%}"
                          });
                          map.addLayer({
                          "id": "Public Colleges",
                          "type": "symbol",
                          "source":"public_colleges",
                          "layout": {
                          "visibility":"none",
                          "icon-image": "public_coll",
                          "icon-size": 0.25
                          }
                        });
                      });
                      // When a click event occurs on a feature in the places layer, open a popup at the
                    // location of the feature, with description HTML from its properties.
                    map.on('click', 'Public Colleges', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var name = e.features[0].properties.name;

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(name)
                    .addTo(map);
                    });

                    // Change the cursor to a pointer when the mouse is over the places layer.
                    map.on('mouseenter', 'Public Colleges', function () {
                    map.getCanvas().style.cursor = 'pointer';
                    });

                    // Change it back to a pointer when it leaves.
                    map.on('mouseleave', 'Public Colleges', function () {
                    map.getCanvas().style.cursor = '';
                    });
                  });

                  //adding university colleges data points
                  map.on('style.load', function() {
                      map.loadImage("{% static 'icons/ic_school_black_48dp.png'%}", function(error, image) {
                      if (error) throw error;
                      map.addImage('university_coll', image);
                        map.addSource('university_colleges',{
                          "type": "geojson",
                          "data": "{%url 'location:university_colleges_data'%}"
                          });
                          map.addLayer({
                          "id": "University Colleges",
                          "type": "symbol",
                          "source":"university_colleges",
                          "layout": {
                          "visibility":"none",
                          "icon-image": "university_coll",
                          "icon-size": 0.25
                          }
                        });
                      });
                      // When a click event occurs on a feature in the places layer, open a popup at the
                    // location of the feature, with description HTML from its properties.
                    map.on('click', 'University Colleges', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var name = e.features[0].properties.name;

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(name)
                    .addTo(map);
                    });

                    // Change the cursor to a pointer when the mouse is over the places layer.
                    map.on('mouseenter', 'University Colleges', function () {
                    map.getCanvas().style.cursor = 'pointer';
                    });

                    // Change it back to a pointer when it leaves.
                    map.on('mouseleave', 'University Colleges', function () {
                    map.getCanvas().style.cursor = '';
                    });
                  });

                  //adding secondary schools data points
                  map.on('style.load', function() {
                      map.loadImage("{% static 'icons/ic_school_black_48dp.png'%}", function(error, image) {
                      if (error) throw error;
                      map.addImage('secondary_sch', image);
                        map.addSource('secondary_schools',{
                          "type": "geojson",
                          "data": "{%url 'location:secondary_schools_data'%}"
                          });
                          map.addLayer({
                          "id": "Secondary Schools",
                          "type": "symbol",
                          "source":"secondary_schools",
                          "layout": {
                          "visibility":"none",
                          "icon-image": "secondary_sch",
                          "icon-size": 0.25
                          }
                        });
                      });
                      // When a click event occurs on a feature in the places layer, open a popup at the
                    // location of the feature, with description HTML from its properties.
                    map.on('click', 'Secondary Schools', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var name = e.features[0].properties.institute;

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(name)
                    .addTo(map);
                    });

                    // Change the cursor to a pointer when the mouse is over the places layer.
                    map.on('mouseenter', 'Secondary Schools', function () {
                    map.getCanvas().style.cursor = 'pointer';
                    });

                    // Change it back to a pointer when it leaves.
                    map.on('mouseleave', 'Secondary Schools', function () {
                    map.getCanvas().style.cursor = '';
                    });
                  });

                  //adding university data points
                  map.on('style.load', function() {
                      map.loadImage("{% static 'icons/ic_school_black_48dp.png'%}", function(error, image) {
                      if (error) throw error;
                      map.addImage('university', image);
                        map.addSource('universities',{
                          "type": "geojson",
                          "data": "{%url 'location:universities_data'%}"
                          });
                          map.addLayer({
                          "id": "Main Universities",
                          "type": "symbol",
                          "source":"universities",
                          "layout": {
                          "visibility":"none",
                          "icon-image": "university",
                          "icon-size": 0.25
                          }
                        });
                      });
                      // When a click event occurs on a feature in the places layer, open a popup at the
                    // location of the feature, with description HTML from its properties.
                    map.on('click', 'Main Universities', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var name = e.features[0].properties.name;

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(name)
                    .addTo(map);
                    });

                    // Change the cursor to a pointer when the mouse is over the places layer.
                    map.on('mouseenter', 'Main Universities', function () {
                    map.getCanvas().style.cursor = 'pointer';
                    });

                    // Change it back to a pointer when it leaves.
                    map.on('mouseleave', 'Main Universities', function () {
                    map.getCanvas().style.cursor = '';
                    });
                  });

                  //adding teachers training colleges data points
                  map.on('style.load', function() {
                      map.loadImage("{% static 'icons/ic_school_black_48dp.png'%}", function(error, image) {
                      if (error) throw error;
                      map.addImage('teachers_training', image);
                        map.addSource('teachers_training_coll',{
                          "type": "geojson",
                          "data": "{%url 'location:teachers_training_data'%}"
                          });
                          map.addLayer({
                          "id": "Teachers Colleges",
                          "type": "symbol",
                          "source":"teachers_training_coll",
                          "layout": {
                          "visibility":"none",
                          "icon-image": "teachers_training",
                          "icon-size": 0.25
                          }
                        });
                      });

                      // When a click event occurs on a feature in the places layer, open a popup at the
                    // location of the feature, with description HTML from its properties.
                    map.on('click', 'Teachers Colleges', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var name = e.features[0].properties.name;

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(name)
                    .addTo(map);
                    });

                    // Change the cursor to a pointer when the mouse is over the places layer.
                    map.on('mouseenter', 'Teachers Colleges', function () {
                    map.getCanvas().style.cursor = 'pointer';
                    });

                    // Change it back to a pointer when it leaves.
                    map.on('mouseleave', 'Teachers Colleges', function () {
                    map.getCanvas().style.cursor = '';
                    });
                  });

                  //turn layers on and off
                  var toggleableLayerIds = [ 'Primary Schools', 'Secondary Schools','Technicals',
                                              'Private Colleges','Private Universities', 'Private Colleges',
                                              'University Colleges', 'Main Universities', 'Teachers Colleges'
                                            ];

                  for (var i = 0; i < toggleableLayerIds.length; i++) {
                      var id = toggleableLayerIds[i];

                      var schoolCheckBox = document.createElement('a');
                        schoolCheckBox.href = '#';
                        schoolCheckBox.className = '';
                        schoolCheckBox.textContent = id;

                      schoolCheckBox.onclick = function (e) {
                          var clickedLayer = this.textContent;
                            e.preventDefault();
                            e.stopPropagation();

                          var visibility = map.getLayoutProperty(clickedLayer, 'visibility');

                          if (visibility === 'visible') {
                          map.setLayoutProperty(clickedLayer, 'visibility', 'none');
                          this.className = '';
                          } else {
                          this.className = 'active';
                          map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
                          }
                      };

                      var layers = document.getElementById('menu-items');
                      layers.appendChild(schoolCheckBox);
                  }
              {% endif %}

      </script>
      <script type="text/javascript">
        {% if all_listings %}
            var allPointsGeojson = {
            type: 'FeatureCollection',
            features: [
            {% for loc in all_listings %}
                {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [{{ loc.location.x }}, {{ loc.location.y }}]
                  },
                properties: {
                    pk: '{{ loc.pk }}',
                    title: '{{ loc.property_name }}',
                    thumb:
                    {% for home_photo in loc.home_photos.all %}
                      {% if forloop.last %}
                      '{% cloudinary_url home_photo.photo ImageTransformation %}'
                      {% endif %}
                    {% endfor %}
                    ,
                    location_name:'{{loc.location_name}}',
                    price:'{{loc.price}}',
                    bathrooms: '{{loc.bathrooms}}',
                    bedrooms: '{{loc.bedrooms}}',
                    floor_area: '{{loc.floor_area}}',
                    size_units : '{{loc.size_units}}',
                    detail_page_url : "{{loc.get_absolute_url}}",
                    created_date:"{{loc.publishdate.date}}"
                }
              },
            {% endfor %}
            ]
            };

            var bounds = new mapboxgl.LngLatBounds();

            allPointsGeojson.features.forEach(function(feature) {
                bounds.extend(feature.geometry.coordinates);
            });

            map.fitBounds(bounds, {padding:50, duration:0});

          //price formatter
          function mFormatter(price) {
            return Math.abs(price) > 999999 ? Math.sign(price)*((Math.abs(price)/1000000).toFixed(1)) + 'm'
                 : Math.abs(price) < 1000000 ? Math.sign(price)*((Math.abs(price)/1000).toFixed(1)) + 'k'
                 : Math.sign(price)*Math.abs(price)
          }

          map.on('style.load', function(){
              map.addSource('allProperty',{
                "type": "geojson",
                "data": allPointsGeojson
              });
              map.addLayer({
              "id": "points",
              "source": 'allProperty',
              "type": "circle",
              });

              if (allPointsGeojson.features.length) {
              map.on('render', 'points', function(e) {
                var features = e.features;
                 features.forEach(function(marker) {
                       var propLink = document.createElement('a');
                           propLink.href = marker.properties.detail_page_url

                       var el = document.createElement('button');
                           el.className = 'customMapMarker popGrp';
                           el.innerHTML = "<span>Ksh</span>" + mFormatter(parseInt(marker.properties.price))

                        propLink.appendChild(el);

                       // make a marker for each feature and add to the map
                       new mapboxgl.Marker(propLink)
                         .setLngLat(marker.geometry.coordinates)
                         .addTo(map);

                      //add a popup to each feature
                      propLink.addEventListener('mousemove', function(){
                        map.getCanvas().style.cursor = 'pointer';
                        popup.setLngLat(marker.geometry.coordinates)
                        .setHTML(
                        '<div id="popup" class="popup popGrp" style="z-index: 10;">' +
                          '<img '+ 'src=' + marker.properties.thumb + '>' +
                          '<ul class="list-group">' +
                          '<li class="list-group-item price">' +"Ksh:" + mFormatter(parseInt(marker.properties.price)) +" </li>" +
                          '<li class="list-group-item features">' +
                              marker.properties.bathrooms +'ba' + ' ' + marker.properties.bedrooms + 'bds'
                              + '<br>' + marker.properties.floor_area +" SQFT </li>"

                       )
                        .addTo(map);
                      })

                      // remove the popup
                      propLink.addEventListener('mouseleave', function(){
                        map.getCanvas().style.cursor = '';
                        popup.remove();
                      });
                 });
             });
             }
          });

      {% endif %}
      </script>
    </div>
    </div>
  </div>
  <div id="_lsPage_scriptsWrpr">
    <div id="_lsPage_scripts" >
        <script type="text/javascript">
          var loader = document.getElementById('_listingItemsLoading');
          var listingsWrapper = document.getElementById('all-row2');
          var listingALLC = document.getElementById('all-content');
          var paginatorBar = document.getElementById('_ls_paginationWrpr');
          var serverEmptyResults = document.getElementsByClassName('_empty_listings');

          var listingEl = document.getElementById('obj');

          var noMatchingResults = document.getElementById('help-text0');

          //When this function initializes
          function renderListings(features) {
              // We the create the listing card elements
              if (features.length) {
                // We reset these because the loader is set to display block
                // and  listingsWrapper paginatorBar divs are set to display none
                // when filter and paginate ajax calls are made to the server by user action
                    //hide loader
                      loader.style.display='none';
                    //..then show listings
                      listingsWrapper.style.display = 'block';
                      paginatorBar.style.display = 'block';
                    // hide no results text
                      noMatchingResults.style.display ='none';
                    // To prevent card duplication we clear any innitial cards
                    // in the objects card container
                    listingEl.innerHTML = '';
                    features.forEach(function(feature) {
                        var prop = feature.properties;
                        var card = document.createElement('div');
                        card.className = 'card';
                        card.id = 'all-card2';

                        var cardOverlay = document.createElement('div');
                        cardOverlay.className = 'all-card-overlay';

                        var name = document.createElement('h5');
                        name.className='all-h-name';
                        name.textContent = prop.title;

                        var locSpan = document.createElement('span');
                            locSpan.textContent = prop.location_name

                        var location = document.createElement('h4');
                        location.target = '_blank';
                        location.className = 'all-h-features';
                        location.textContent = prop.bathrooms +'ba' + ' ' + prop.bedrooms + 'bds' + ' ' + prop.floor_area + '  SQFT';

                        var allDtls = document.createElement('div');
                            allDtls.className='_all_d_wrp_bx';

                        var price = document.createElement('h3');
                        price.target = '_blank';
                        price.className = 'all-h-price';
                        price.textContent = "Ksh: " + prop.price;

                        var date = document.createElement('h6');
                        date.target = '_blank';
                        date.className = 'all-a-date';
                        date.textContent = 'Last update on: ' + prop.created_date;

                        var image = document.createElement("img");
                        image.src = prop.thumb;
                        image.id = 'all-image2';

                        var detailsLink = document.createElement('a');
                        detailsLink.id= 'detailsLink';
                        detailsLink.href = prop.detail_page_url;
                        detailsLink.target='_blank';

                        var heartIcon = document.createElement('button')
                            heartIcon.setAttribute("data-propertypk", prop.pk);
                            heartIcon.innerHTML = "<i class='fas fa-heart'></i>"
                            if (prop.is_saved ==='True') {
                              heartIcon.className = '_lssaveProperty _lsIs_saved';
                            }else {
                              heartIcon.className = '_lssaveProperty';
                            };





                        card.addEventListener('mouseover', function() {
                            // Highlight corresponding feature on the map
                            popup.setLngLat(feature.geometry.coordinates)
                            .setHTML(
                            '<div id="popup" class="popup" style="z-index: 10;">' +
                              '<img '+ 'src=' + feature.properties.thumb + '>' +
                              '<ul class="list-group">' +
                              '<li class="list-group-item price">' +"Ksh:" + mFormatter(parseInt(feature.properties.price)) +" </li>" +
                              '<li class="list-group-item features">' +
                                  feature.properties.bathrooms +'ba' + ' ' + feature.properties.bedrooms + 'bds'
                                  + '<br>' + feature.properties.floor_area + " SQFT</li>"

                           )
                            .addTo(map);
                        });

                        card.addEventListener('mouseleave', function() {
                            map.getCanvas().style.cursor = '';
                            popup.remove();
                        });


                        listingEl.appendChild(card);
                        detailsLink.appendChild(image);
                        detailsLink.appendChild(date);
                        detailsLink.appendChild(cardOverlay);
                        allDtls.appendChild(name);
                        allDtls.appendChild(price);
                        location.appendChild(locSpan);
                        allDtls.appendChild(location);
                        cardOverlay.appendChild(allDtls)
                        card.appendChild(heartIcon);
                        card.appendChild(detailsLink);

                    });
              }

              else {
                    if (loader != null && listingsWrapper != null) {
                      loader.style.display='none';
                      listingsWrapper.style.display = 'none';
                    };
                    if (serverEmptyResults.length === 0) {
                        noMatchingResults.style.display ='block';
                    };
                  }
          };

          {% if listings %}
              //price formatter
              function mFormatter(price) {
                return Math.abs(price) > 999999 ? Math.sign(price)*((Math.abs(price)/1000000).toFixed(1)) + 'm'
                     : Math.abs(price) < 1000000 ? Math.sign(price)*((Math.abs(price)/1000).toFixed(1)) + 'k'
                     : Math.sign(price)*Math.abs(price)
              }

              //median function
              function median(numbers) {
                  const sorted = numbers.slice().sort((a, b) => a - b);
                  const middle = Math.floor(sorted.length / 2);

                  if (sorted.length % 2 === 0) {
                      return (sorted[middle - 1] + sorted[middle]) / 2;
                  }

                  return sorted[middle];
              }

              $(document).ready(function(){
                //Updates the result insights section
                  var insightText = document.getElementById('_listingsVS_ctTxt');
                      if ('{{filter_fields.property_type}}' != '') {
                          insightText.textContent =
                              "The median " + {% if listing.listing_type == 'for-sale' %}"price"{%else%} "rent"{% endif %} +
                              " for a {{filter_fields.bedrooms}} bedroom {{filter_fields.property_type}} " +
                              "in this area is " + mFormatter(parseInt({{insight_stats.n_bds_median_price}})) + " while the median " +
                              {% if listing.listing_type == 'for-sale' %}"price"{%else%}"rent"{% endif %} +
                              " for a 3 bedroom plus house is " + mFormatter(parseInt({{insight_stats.threebd_plus_price_trend}})) +".";
                        }else {
                          insightText.textContent =
                              "The median " + {% if listing.listing_type == 'for-sale' %}"price"{%else%}"rent"{% endif %} +
                              " for a 1 bedroom house in this area is " + mFormatter(parseInt({{insight_stats.Onebd_median_price}})) +
                              " while the median " + {% if listing.listing_type == 'for-sale' %}"price"{%else%} "rent"{% endif %} +
                              " for a 3 bedroom plus house is " + mFormatter(parseInt({{insight_stats.Threebd_plus_median_price}})) +".";
                        };

                  var _1bdStatPg = document.getElementById('_ls_Bx1StatsPg');
                      _1bdStatPg.textContent = mFormatter(parseInt({{insight_stats.Onebd_median_price}}))


                  var _2bdStatPg = document.getElementById('_ls_Bx2StatsPg');
                      _2bdStatPg.textContent = mFormatter(parseInt({{insight_stats.Twobd_median_price}}))


                  var _3bdStatPg = document.getElementById('_ls_Bx3StatsPg');
                      _3bdStatPg.textContent = mFormatter(parseInt({{insight_stats.Threebd_plus_median_price}}))


                  var _allStatsPg = document.getElementById('_ls_BxAllStatsPg');
                      _allStatsPg.textContent = mFormatter(parseInt({{insight_stats.all_prices_median}}))
              });

              // Holds visible listings features for filtering
              var homes = [];

              // Create a popup, but don't add it to the map yet.
              var popup = new mapboxgl.Popup({
                  closeButton: false
              });


              var geojson = {
              type: 'FeatureCollection',
              features: [
              {% for property in listings %}
                  {
                  type: 'Feature',
                  geometry: {
                      type: 'Point',
                      coordinates: [{{ property.location.x }}, {{ property.location.y }}]
                  },
                  properties: {
                      pk: '{{ property.pk }}',
                      title: '{{ property.property_name }}',
                      thumb:
                          {% for home_photo in property.home_photos.all %}
                            {% if forloop.last %}
                            '{% cloudinary_url home_photo.photo ImageTransformation %}'
                            {% endif %}
                          {% endfor %}
                          ,
                      location_name:'{{property.location_name}}',
                      price:'{{property.price}}',
                      bathrooms: '{{property.bathrooms}}',
                      bedrooms: '{{property.bedrooms}}',
                      floor_area: '{{property.floor_area}}',
                      size_units : '{{property.size_units}}',
                      detail_page_url : "{{property.get_absolute_url}}",
                      created_date:"{{property.publishdate.date}}",
                      is_saved: "{% if request.user in property.saves.all %}True{%else%}False{%endif%}",
                  }
                  },
              {% endfor %}
              ]
              };

              //get cookie function
              function getCookie(c_name){
                  if (document.cookie.length > 0)
                  {
                      c_start = document.cookie.indexOf(c_name + "=");
                      if (c_start != -1)
                      {
                          c_start = c_start + c_name.length + 1;
                          c_end = document.cookie.indexOf(";", c_start);
                          if (c_end == -1) c_end = document.cookie.length;
                          return unescape(document.cookie.substring(c_start,c_end));
                      }
                  }
                  return "";
               }


              function getUniqueFeatures(array, comparatorProperty) {
                  var existingFeatureKeys = {};
                  // Because features come from tiled vector data, feature geometries may be split
                  // or duplicated across tile boundaries and, as a result, features may appear
                  // multiple times in query results.
                  var uniqueFeatures = array.filter(function(el) {
                      if (existingFeatureKeys[el.properties[comparatorProperty]]) {
                        return false;
                      } else {
                        existingFeatureKeys[el.properties[comparatorProperty]] = true;
                        return true;
                      }
                  });


                  return uniqueFeatures;
              }

              map.on('style.load', function(){
                  map.addSource('property',{
                    "type": "geojson",
                    "data": allPointsGeojson
                  });
                  map.addLayer({
                  "id": "flPoints",
                  "source": 'property',
                  "type": "circle",
                  });

                  //Method updates insights card when map is panned or zoomed by the user
                  map.on('render',function() {
                      var features = map.queryRenderedFeatures({layers: ['flPoints']});
                      if (features) {
                        var uniqueFeatures = getUniqueFeatures(features, "pk");

                        //Updates the results count text on the map on each render
                        var helpText1 = document.getElementById('mapResultshelp-text1');
                            helpText1.innerHTML = '<p>'+ 'Showing ' + uniqueFeatures.length + ' of ' +
                                                  {{listings_count}} + ' results in this area.' +
                                                  '<span>Pan or zoom the map to filter</span>' + '</p>';
                      }
                  });

                //Ajax filter methods from here
                //These methods initiate the click event on the submit button for
                //the filter form so that we can be able to get its data.
                //Listen to the map pan or zoom by the user and submit filters
                    map.on('moveend',function() {
                        $('#submit_f_button')[0].click(function(){})
                    });

                    //Ajax pagination method
                    var pageNumber = $('.pagination-current').attr('data-pagenumber');
                    $(document).on('click', '._pageNumber', function () {
                      pageNumber = $(this).attr('data-PageNumber');
                      $('#submit_f_button')[0].click(function(){})

                    });

                    //Ajax sorting
                    var sortValue = $('#sort-input select').val();
                    $(document).on('change', '#sort-input select', function(){
                      sortValue = $(this).val()
                      $('#submit_f_button')[0].click(function(){})
                    });

                    //Ajax Filter
                    $('#_lsRsFl_Form').on('change', ' input , select', function(){
                      $('#submit_f_button')[0].click(function(){})

                    });

                // This method acts as the base filter method
                // When it fires it collects the data for all filter and sort
                // parameters the page. This helps the server maintain a consistent
                // filter order on the database query
                    var innitialLocationInputValue = $('#geocoder input').val();

                    $(document).on('submit','#_lsRsFl_Form', function(event){
                      var newLocationInputValue = $('#geocoder input').val();

                      if (newLocationInputValue === innitialLocationInputValue) {
                          event.preventDefault()
                          //getting the filter form data
                          var mainFilterForm = document.getElementById('_lsRsFl_Form');
                          var _filterFormData = $(this).serializeArray()
                              _filterFormData = JSON.stringify(_filterFormData);
                          //Query the features rendered on the map
                          var features = map.queryRenderedFeatures({layers: ['flPoints']});

                          //making sure the features are not empty
                          if (features) {
                            //Get the features based on their unique value (i.e. pk).
                            //and create a pk array
                            var uniqueFeatures = getUniqueFeatures(features, "pk");
                            var pk_array = []
                            for (var i = 0; i < uniqueFeatures.length; i++) {
                              pk_array.push(parseInt(uniqueFeatures[i].properties.pk))
                            };

                            //showing loader
                            loader.style.display='block';
                            //hiding the listings wrapper untill new results are rendered to the dom
                            listingsWrapper.style.display = 'none';
                            //hiding the pagination bar untill new results are rendered to the dom
                            paginatorBar.style.display = 'none';
                            //Make call to the server
                              $.ajax({
                                  type: "GET",
                                  url: './',
                                  data:{
                                      'filterFormData':_filterFormData,
                                      'sort':sortValue,
                                      'page': pageNumber,
                                      'properties_array':pk_array,
                                  },
                                  success: function (data) {
                                    //re-render our desired potions on the page with new data
                                        $("#_lsPage_scriptsWrpr").html($(data).find('#_lsPage_scripts'));
                                        $("#_ls_paginationWrpr").html($(data).find('#ls_pagination'));
                                        $('#_sQstring_ospamxcpl').val( $(data).find('#_sQstring_ospamxcpl').val() );
                                        var q_string = $(data).find('#_sQstring_ospamxcpl').val();
                                        window.history.pushState({qs : q_string }, null, "?" + q_string );
                                      }
                                  });

                          }
                        }else {
                          console.log('here');
                            $.ajax({
                                type: "GET",
                                url: './',
                                data:{
                                    'location':newLocationInputValue,
                                },
                                success: function (data) {}
                                });
                        }
                    })


                //property save method
                $(document).on('click', '._lssaveProperty', function(){
                      var savedProperty = $(this);
                      $.ajax({
                          type: "POST",
                          url: "{% url 'listings:save_property'%}",
                          data: {
                              'pk': savedProperty.attr('data-propertypk'),
                              'property_category':'homes',
                              'csrfmiddlewaretoken': '{{ csrf_token }}',
                          },
                          success: function (responseData) {
                            if (responseData.is_saved === true) {
                              savedProperty.attr('class', '_lssaveProperty _lsIs_saved')
                            }else {
                              savedProperty.attr('class', '_lssaveProperty')
                            }

                          },
                          error: function(rs,e){
                          },
                    });
                });

              });

              // Calling this function on initialization
              // and passing an innitial array from the server
              renderListings(geojson.features);

              //Toggles Map style
                //Begins here
                var layerList = document.getElementById('_MapsMenu');
                var layerChoices = layerList.getElementsByTagName('input');

                function switchLayer(layer) {
                  var layerId = layer.target.id;
                  map.setStyle('mapbox://styles/reykennedy/' + layerId);
                }

                for (var i = 0; i < layerChoices.length; i++) {
                  layerChoices[i].onclick = switchLayer;
                }
                //ends here

              //Triggers animation when save button is clicked
                //Begins here
                if (document.body.animate) {
                  document
                    .querySelectorAll("._lssaveProperty")
                    .forEach((button) => button.addEventListener("click", pop));
                }

                function pop(e) {
                  for (let i = 0; i < 30; i++) {
                    createParticle(e.clientX, e.clientY, e.target.dataset.type);
                  }
                }

                function createParticle(x, y, type) {
                  const particle = document.createElement("particle");
                  document.body.appendChild(particle);

                  const size = Math.floor(Math.random() * 20 + 5);

                  particle.style.width = `${size}px`;
                  particle.style.height = `${size}px`;

                  const destinationX = x + (Math.random() - 0.5) * 2 * 75;
                  const destinationY = y + (Math.random() - 0.5) * 2 * 75;

                  // switch (type) {
                  //   case "circle":
                      particle.style.background = `hsl(10, 90%, 50%)`;
                      particle.style.borderRadius = "50%";
                  //     break;
                  //   case "square":
                  //     particle.style.background = `hsl(${Math.random() * 90 + 270}, 70%, 60%)`;
                  //     particle.style.border = "1px solid white";
                  //     break;
                  //   default:
                  //     particle.style.background = `hsl(${Math.random() * 90 + 180}, 70%, 60%)`;
                  // }

                  const animation = particle.animate(
                    [
                      {
                        // Set the origin position of the particle
                        // We offset the particle with half its size to center it around the mouse
                        transform: `translate(${x - size / 2}px, ${y - size / 2}px)`,
                        opacity: 1,
                      },
                      {
                        // We define the final coordinates as the second keyframe
                        transform: `translate(${destinationX}px, ${destinationY}px)`,
                        opacity: 0,
                      },
                    ],
                    {
                      duration: 500 + Math.random() * 1000,
                      easing: "cubic-bezier(0, .9, .57, 1)",
                      delay: Math.random() * 200,
                    }
                  );

                  animation.onfinish = () => {
                    particle.removeParticle;
                  };
                }

                function removeParticle(e) {
                  e.srcElement.effect.target.remove();
                }
                //ends here

            {% else %}
              renderListings([]);
              //Ajax Filter
              $('#_lsRsFl_Form').on('change', ' input , select', function(){
                $('#submit_f_button')[0].click(function(){})
              });
              var innitialLocationInputValue = $('#geocoder input').val();

              $(document).on('submit','#_lsRsFl_Form', function(event){
                //new location input value
                var newLocationInputValue = $('#geocoder input').val();

                if (newLocationInputValue != '') {
                  $.ajax({
                      type: "GET",
                      url: './',
                      data:{
                          'location':newLocationInputValue,
                      },
                      success: function (data) {}
                      });
                } else {
                  event.preventDefault()
                };

              })
            {%endif %}
              $(document).on('click', '#saveSearch_button_dk', function(){
                var successmsgBody = $('#upfPageAcScs');
                var errmsgBody = $('#upfPageAcErr');
                  $.ajax({
                    type: "POST",
                    url: "{% url 'listings:save_search' %}",
                    data:{
                      'queryString':'{{request.build_absolute_uri}}',
                      'csrfmiddlewaretoken':'{{csrf_token}}'
                    },
                    success: function (response) {
                        if (response['message'] === 'sucess') {
                          successmsgBody.html("<span class='material-icons'>check_circle_outline</span> Success. Search saved.")
                          successmsgBody.css({'display': 'flex','bottom':'10px'})
                          setTimeout(function(){
                             successmsgBody.css('bottom','-100px');
                          }, 6000);
                        }else {
                          errmsgBody.html("<span class='material-icons'>error_outline</span> Something went wrong. We could not save your search.")
                          errmsgBody.css({'display': 'flex','bottom':'10px'})
                          setTimeout(function(){
                             errmsgBody.css('bottom','-100px');
                          }, 6000);
                        };
                      }
                  });
              });
          </script>
          <script type="text/javascript">
            $(document).ready(function(){
                document.querySelector(".mapboxgl-ctrl-geocoder--input").value="{{location_address}}";
                document.querySelector(".mapboxgl-ctrl-geocoder--input").name="location";
                $('#price-from select').val('{{filter_fields.min_price}}');
                $('#price-to select').val('{{filter_fields.max_price}}');
                $('#type-filter select').val('{{filter_fields.property_type}}');
                $('#beds select').val('{{filter_fields.bedrooms}}');
                $('#baths select').val('{{filter_fields.bathrooms}}');
                $('#sort-input select').val('{{filter_fields.sort}}');

                var openMapBtn = document.getElementById('revealMap');
                var closeMapBtn = document.getElementById('hideMapbtn');

                openMapBtn.addEventListener('click',function() {
                    var mapContainer = document.getElementById("map-container");
                        mapContainer.style.display="flex";
                    });

                closeMapBtn.addEventListener('click', function(){
                    var mapContainer = document.getElementById("map-container");
                        mapContainer.style.display="none";
                  });
              });
          </script>
    </div>
  </div>
</section>
{% endblock %}
